# 一周值班接手指南（Mattermost 单机生产服务器）

> 目标读者：第一次接手本服务器值班的运维 / SRE
> 
> 目标状态：
> 
> - **不依赖原作者**
>     
> - **能独立完成 7 天值班**
>     
> - **遇到问题知道“看哪里、用哪个文件、怎么做”**
>     
> 
> 本文是**唯一值班入口文档**，所有操作都必须能在本文中找到路径。

---

## 0. 你接手的是什么

- **业务**：Mattermost（企业内部即时通讯）
    
- **规模**：单机生产环境
    
- **部署方式**：Docker Compose + Nginx
    
- **核心原则**：
    
    - 不追求高可用
        
    - 不追求自动化
        
    - 追求 **可治理 / 可恢复 / 可交接**
        

---

## 1. 第一天你必须先看哪些文件（顺序不可变）

### 1.1 总体架构与环境

**文件**：

``1-docs/ARCH/environments.md``

**你要搞清楚的事**：

- 什么是 Sandbox / Staging / Prod
    
- 为什么只有一台机器还能有三域
    
- 哪些目录是生产，哪些不能乱动
    

---

### 1.2 权限与登录边界（非常重要）

**文件**：

``1-docs/POLICIES/IAM.md``

``1-docs/RUNBOOK/access.md``

**你要搞清楚的事**：

- 你用哪个用户登录（通常是 `ratio`）
    
- root 为什么不能 SSH
    
- sudo 为什么只能跑特定命令
    
- 出问题时如何 break-glass
    

**禁止事项**：

- 不要尝试 `sudo su -`
    
- 不要把自己加进 docker 组
    

---

### 1.3 服务结构与入口

**文件**：

``1-docs/ARCH/nginx-layout.md``

**你要搞清楚的事**：

- Nginx 和 Mattermost 的关系
    
- 为什么 staging / prod 共用 nginx
    
- 哪些 nginx 改动会直接影响生产
    

---

## 2. 日常值班你每天要做什么

### 2.1 日巡检（每天 1 次）

**文件模板**：

``5-reports/inspections/infra-daily-inspection-YYYYMMDD.md``
**参考文件**：

``5-reports/inspections/infra-daily-inspection-20260121.md``

**巡检步骤**：

1. 磁盘使用率是否有异常增长
    
2. Docker / Nginx 日志是否有 error spike
    
3. 备份目录是否有最新日期
    
4. TLS 证书是否接近过期
    

**命令示例**：

```
df -h

sudo docker compose ps

sudo docker compose logs nginx | tail

ls /data/backups
```

---

## 3. 服务操作（最常用）

### 3.1 查看服务状态

**目录**：

``/home/ratio/mattermost/environments/prod``

**命令**：

```
sudo docker compose ps
```

---

### 3.2 安全重启服务

**原则**：

- 不直接 kill
    
- 不乱 down
    

**操作**：

```
sudo docker compose restart
```

---

### 3.3 仅重载 Nginx（首选）

```
sudo docker compose restart nginx
```

---

## 4. 变更操作（不是每天，但最危险）

### 4.1 变更前你必须做什么

**文件**：

``1-docs/POLICIES/change-management.md``

**原则**：

- 任何变更先去 Staging
    
- Prod 只允许复制已验证配置
    

---

### 4.2 变更记录必须写在哪里

**文件名格式**：

``5-reports/change-record-YYYYMMDD-XX-<topic>.md``

**示例**：

``change-record-20260120-01-staging-verify.md``

---

## 5. 出事故了你该怎么办（最重要一章）

### 5.1 第一反应

- 先确认用户路径是否真的失败
    
- 不要立刻改配置
    

---

### 5.2 查阅事故处理 Runbook

**文件**：

``1-docs/SOP/incident.md``

**历史事故参考**：

``5-reports/incidents/incident-sim-20260121-01-mattermost-502.md``

---

### 5.3 常见问题入口

|现象|先看哪里|
|---|---|
|502|nginx logs / upstream|
|无法登录|app logs / DB|
|文件上传失败|ACL / 权限清单|

**权限检查清单**：

``1-docs/CHECKLIST/mattermost-permission-checklist.md``

---

## 6. 备份与恢复（不要等事故才看）

### 6.1 备份在哪里

``/data/backups/YYYYMMDD/``

---

### 6.2 恢复怎么做

**完整演练文档**：

``5-reports/backups/mattermost-backup-restore-20260121-01.md``

> 注意：
> 
> - 数据库恢复 ≠ 业务恢复
>     
> - 文件数据必须一起恢复
>     

---

## 7. 最坏情况：系统救援

### 7.1 什么情况下需要救援

- sudoers 写炸
    
- sshd 无法启动
    
- fstab 配错
    
- 系统无法登录
    

---

### 7.2 救援 Runbook

**文件**：

``1-docs/RUNBOOK/system-rescue.md``

**原则**：

- 只用云控制面 root
    
- 修完立刻退出 root
    

---

## 8. 仓库即系统的一部分

### 8.1 仓库审计结果

**文件**：

``5-reports/infra-verification-20260121-01-repo-audit.md``

### 8.2 修改仓库的规则

- 不提交敏感信息
    
- 报告类文件必须带日期
    
- SOP / POLICY 不带日期
    

---

## 9. 值班一周的最低成功标准

你这一周如果做到以下几点，视为 **独立值班成功**：

- 每天 1 份日巡检
    
- 无越权操作
    
- 发生异常能按 Incident 流程处理
    
- 不需要问“这个文件在哪”
    

---

## 10. 最后一句话

> 这台服务器不是靠“人记住”运转的， 而是靠 **文件、流程和约束**。
> 
> 如果你发现某一步需要“问原作者”， 那说明文档还需要补。