# 背景知识（心智模型）— Linux 运维训练的“系统语言”

> 目标不是“学懂内核”，而是建立一套稳定的**系统语言**：  
> 你在巡检与排障时，必须能用它清楚地描述系统、提出假设、并用验证动作否定假设。

---

## 0. 四个高阶视角：资源、状态、队列、边界
任何一次巡检/排障，你都应该在脑中把问题归入这四类之一（或其组合）：

1) **资源（Resource）**：CPU/内存/磁盘空间/IO/网络/文件句柄等是否不足或被异常消耗？  
2) **状态（State）**：服务/进程/连接是否处于错误状态（崩溃、僵死、锁住、等待）？  
3) **队列（Queue）**：请求/任务是否在某处排队（run queue、连接队列、IO 队列、应用队列）？  
4) **边界（Boundary）**：权限、路径、端口、ACL、配额、cgroup、ulimit 等边界条件是否被触发？

> 训练要求：每次动作都要能回答“我在否定哪个假设”。

---

## 1. 负载（Load Average）不是 CPU 使用率
- Load Average：单位时间内 **可运行 + 不可中断等待（D 状态）** 的任务数  
- 典型误区：load 高 ≠ CPU 高；load 也可能是 IO/锁/磁盘导致的 D 状态

**经验语句**
- “load 高但 CPU idle 高”：往往是 IO/锁等待（队列/状态问题）  
- “CPU 高但 load 不高”：可能是少数进程吃满 CPU（资源问题）

---

## 2. CPU 的关键状态语义
- user/sys：用户态/内核态 CPU 消耗（CPU 真忙）
- iowait：CPU 等待 IO（常与磁盘/网络 IO 相关）
- steal：虚拟化环境被“偷走”的 CPU（单机多见为 0）

**你要能说的话**
- “CPU 忙在哪里？是 user 还是 sys？是否伴随 iowait？”
- “是否存在大量上下文切换（context switch）导致‘忙但不做事’？”

---

## 3. 进程状态（R/S/D/Z/T）与排障意义
- R：可运行/正在运行（CPU 竞争）
- S：可中断睡眠（正常等待）
- D：不可中断睡眠（常见于 IO/锁等待，排障重点）
- Z：僵尸（父进程未回收）
- T：停止（调试/信号）

**关键点**
- D 状态与 load、IO、文件系统、块设备队列强相关；这是“队列/状态”类问题的典型入口。

---

## 4. 内存：可用 ≠ 空闲
Linux 会用 page cache 提升性能，所以：
- free 小不一定是问题
- 关键看：是否发生频繁 reclaim、swap、OOM

**你要能描述**
- “内存压力表现为：swap 增长、kswapd 活跃、major page faults 增多”
- “OOM 发生的条件、被杀进程与业务影响”

---

## 5. 磁盘：空间、inode、IO 三件事分开看
- 空间满：服务写日志/写数据失败最常见
- inode 满：小文件过多导致“空间还够但无法创建文件”
- IO 慢：会表现为 D 状态、延迟升高、应用超时

**你要能描述**
- “是容量问题还是性能问题？是空间/inode 还是 IO 延迟？”

---

## 6. 网络：连接、延迟、DNS、端口
单机也会遇到典型网络类问题：
- 端口冲突（边界）
- 连接耗尽（队列）
- DNS 解析异常（状态/边界）
- backlog/连接队列爆（队列）

**你要能描述**
- “服务不可用：是进程没起来？端口没监听？还是连接队列/超时？”
- “DNS 问题通常体现为：偶发/全量失败、解析慢、缓存污染”

---

## 7. systemd 与“服务状态语言”
你需要区分三件事：
- **进程存在**（ps 能看到）  
- **服务可用**（健康检查通过）  
- **业务可用**（用户路径成功）

常见陷阱：
- 服务 active 但业务不可用（配置错误/依赖不可用/权限边界触发）
- 服务频繁重启（Restart=，崩溃循环）

---

## 8. 日志与时间：排障必须统一时间轴
- 统一时区与时间同步（否则日志串不上）
- 日志要回答：谁、何时、对什么、做了什么、结果如何

**你要能写出来**
- “在 T0 发生了变更；T1 出现错误；T2 告警触发；T3 恢复；T4 复盘产物”

---

## 9. 最小权限：认证（AuthN）与授权（AuthZ）分开想
- AuthN：你是谁（账号/密钥/证书）
- AuthZ：你能做什么（权限、组、ACL、sudo、策略）

排障中常见的“边界类问题”：
- 目录权限/属主不对
- sudo 规则过宽/过窄
- service 账号缺读写权限
- ulimit/cgroup 限额触发（文件句柄/进程数/内存）

---

## 10. 训练时强制自问（不问就不允许继续）
1) 我当前的主要异常属于：资源 / 状态 / 队列 / 边界？  
2) 我下一步动作能否**否定一个假设**？被否定的假设是什么？  
3) 我是否已经有：验证点、回滚点、留痕？

---

## 结语
这份心智模型的作用是：保证你在任何场景中
- 不会用错语言描述系统
- 不会把“状态”误判为“根因”
- 不会因为“命令熟悉”而放弃思考

它解决的不是“会不会敲命令”，而是“是否具备进入真实运维场景的资格”。
