# 故障排查肌肉记忆（题库）— 统一框架 + 可重复演练

> 目标：把“排障”训练成 **固定顺序 + 固定检查点 + 固定留痕** 的工程动作，而不是临场灵感。  
> 环境：Ubuntu 单机（建议三域：Sandbox/Staging/Exam）。故障注入仅在 Sandbox/Staging。

---

## 0. 训练纪律（必须遵守）
1) **先观察后修改**：禁止开局就改配置/重启服务。  
2) **一次只验证一个假设**：不要同时改多个变量。  
3) **最小干预**：优先选择低风险动作，必须有回滚点。  
4) **全程留痕**：命令、输出摘要、配置 diff、时间线。  
5) **复盘资产化**：每题结束必须形成 Runbook/复盘条目。

---

## 1. 统一排障框架（通用于所有题）
### 1.1 开局三问（强制）
1) 当前主要异常属于：**资源 / 状态 / 队列 / 边界** 哪一类？  
2) 影响范围：单点/全量？用户路径的失败点在哪里？  
3) 最近变更：是否存在（配置/发布/证书/权限/计划任务）？

### 1.2 L1 起手动作（固定顺序）
> 目的：在 3–5 分钟内，把问题收敛到可验证的假设集合。

- 用户视角快速验证：健康检查/关键接口/关键日志一句话描述
- 服务状态：systemd 状态、重启历史、最近失败原因
- 资源态：CPU/内存/磁盘空间&inode/IO/网络连接
- 日志入口：journal（按服务/时间窗口）、应用日志（错误峰值）
- 近期变更线索：最近部署、配置 diff、计划任务、证书到期

> 具体命令清单请在你的仓库中维护为 `docs/CHECKLIST/incident_L1.md`，并在每次复盘中持续迭代。

### 1.3 假设→验证→修复→回滚（L2）
- 列出 3–5 个高优先级假设（按可能性×影响）
- 为每个假设写一条验证动作与预期结果
- 选最小干预修复；修复后必须做“用户路径验证”
- 如不满足预期，立即回滚并记录“为何回滚”

---

## 2. 题库使用方式（如何练成肌肉记忆）
每道题都按同一模板执行：

- **时间盒**：TTD（定位）≤ 10–15 分钟；TTR（恢复）≤ 30–60 分钟（按难度）
- **成功标准**：恢复业务路径 + 证据留存 + 复盘条目
- **产物**：事件记录（Incident Record）+ Runbook（1 页内）+ Checklist 修订（如有）

### 2.1 事件记录模板（建议）
- 事件编号/时间线（T0/T1/T2…）
- 现象（用户语言）→ 系统语言（资源/状态/队列/边界）
- 假设表（优先级、验证、结果）
- 修复动作（风险点、回滚点、验证点）
- 根因与改进项（预防/监控/容量/流程）

---

## 3. 题库（单机可复现的真实事故集合）
> 注：以下题目描述以“可注入、可恢复”为原则；注入细节建议用脚本化方式维护在 `labs/inject/`。

### A 组：可用性（Availability）
**A1｜应用进程存在但业务不可用（健康检查失败）**  
- 典型根因：配置错误、依赖不可用、权限边界触发  
- 成功标准：恢复用户路径；能说明“进程存在≠可用≠业务可用”

**A2｜Nginx 502/504**  
- 典型根因：upstream 未监听/超时/权限导致后端异常  
- 成功标准：区分 Nginx 与后端责任边界；恢复并记录验证链路

**A3｜端口冲突导致服务启动失败**  
- 典型根因：重复实例/旧进程残留  
- 成功标准：定位监听者、选择最小影响处理（而非盲目 killall）

**A4｜systemd unit 启动失败/重启风暴**  
- 典型根因：ExecStart 错误、环境变量缺失、权限不足、依赖未就绪  
- 成功标准：通过 systemd 状态与日志定位；修复后稳定运行

---

### B 组：容量与日志（Capacity/Logging）
**B1｜磁盘空间耗尽（日志暴涨）**  
- 典型根因：错误循环、访问量激增、日志轮转失效  
- 成功标准：短期止血（保护系统）+ 长期修复（轮转/阈值/告警）

**B2｜inode 耗尽（小文件风暴）**  
- 典型根因：临时文件、缓存目录爆炸  
- 成功标准：识别“空间还够但无法写入”的特征；安全清理与预防

**B3｜journal/应用日志时间线混乱**  
- 典型根因：时间不同步、时区混用、日志格式不一致  
- 成功标准：把时间线串起来并输出事件记录

---

### C 组：性能（Performance）
**C1｜CPU 100%（单进程吃满）**  
- 典型根因：死循环、异常请求、加密/压缩等高 CPU  
- 成功标准：确认瓶颈点与影响范围；做低风险缓解（如限流/降级的“单机版替代动作”）

**C2｜load 高但 CPU idle 高（D 状态/IO 等待）**  
- 典型根因：磁盘 IO 慢、文件系统问题、锁等待  
- 成功标准：解释“为什么 load 高”；通过 IO/进程状态验证

**C3｜内存持续增长最终 OOM**  
- 典型根因：缓存策略/内存泄漏/错误配置  
- 成功标准：区分 cache 与 RSS；能解释 OOM 证据并给出预防措施

---

### D 组：权限与边界（Boundary/IAM）
**D1｜发布后应用无法读写数据目录**  
- 典型根因：属主/属组/权限、umask、服务账号变化  
- 成功标准：用最小权限修复；补全权限矩阵或 SOP

**D2｜sudo 规则过宽/过窄导致风险或阻断**  
- 典型根因：误配 sudoers、缺审计  
- 成功标准：修复并加上验证点与审计要求

---

### E 组：计划任务与备份（Cron/Backup）
**E1｜备份任务悄悄失败（但无告警）**  
- 典型根因：权限、路径、磁盘满、脚本错误、环境变量  
- 成功标准：补齐“备份可恢复”的证据链；增加巡检项/告警项

**E2｜误删文件/误改配置后的恢复演练**  
- 成功标准：在时间盒内完成恢复；能证明恢复后的服务可用

---

### F 组：TLS/证书（单机模拟）
**F1｜证书过期导致 HTTPS 失败**  
- 成功标准：能识别到期证据、完成轮换流程（含回滚预案），并在巡检清单中加入到期预警

---

## 4. 难度分级与验收映射
- L0（基础）：按 Checklist 能完成 L1 起手并写出 3 个假设  
- L1（岗位可用）：多数题目能在时间盒内恢复，并输出事件记录  
- L2（可独立值班）：能做影响控制、回滚决策、复盘并改进 SOP/监控  
> 具体能力映射见《运维能力.md》。

---

## 5. 题库维护规则（避免“背答案”）
- Exam 域题目必须“未知初始条件”（通过 reset 脚本随机化非关键变量）
- 每题至少有 2 种根因变体（同现象不同根因）
- 每次复盘都必须更新：Runbook 或 Checklist（避免重复踩坑）
